{% extends "base.html" %}

{% block title %}
    GG2 Contracts - Profile
{% endblock %}

{% block content %}
<h1>Update your profile</h1>
<p>
    Update your profile using your user key. <br/>
    You can find your contracts user key in your <code>gg2.ini</code> .<br/>
    If you reached this page through the plugin menu in game, your user key is already filled in!
</p>
<p>
    If you don't have one, sign up by playing on a server that runs the contracts plugin!
</p>
<h2 id="message"></h2>
<form id="myform">
    Login key: <input id="userkey" name="key" placeholder="123456789012-1234-1234-1234-12345678" /> (find it in your gg2.ini after playing a game with contracts) <br/>
    <button type="submit">Submit</button>
</form>
{% if discord_oauth_login_url %}
    <p>
        {% if tried_to_login_with_discord %}
            Failed to log in with Discord. Did you previously link your accounts?<br/>
            You will need your user key, which you can find in your <code>gg2.ini</code> file.<br/>
            You cannot create a Contracts account with Discord.<br/>
        {% endif %}
        <a href="{{ discord_oauth_login_url }}"><button>Login with Discord <img width="12" src="{{ url_for('static', path='assets/discord.png') }}" /></button></a>
    </p>
{% endif %}
{% endblock %}

{% block extra_js %}
<script>
    window.addEventListener("load", function () {
        const givenKey = window.location.hash.substring(1);
        document.getElementById("userkey").setAttribute("value", givenKey);
        document.getElementById("myform").addEventListener("submit", function (e) {
            e.preventDefault();
            const formData = new FormData(e.target);

            const formKey = formData.get("key");
            if (formKey.length < 16) {
                document.getElementById("message").textContent = "Invalid key"
                return;
            }
            
            document.getElementById("message").textContent = "Sending..."
            fetch("/api/me/login", {
                method: "post",
                headers: {
                    'Accept': 'application/json',
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    "token": formData.get("key"),
                })
            })
            .then( async (response) => {
                return {
                    "status": response.status,
                    "content": await response.text(),
                }
            }).then( (response) => {
                let respText;
                if (response.status < 300) {
                    e.target.reset();
                    window.location.reload();
                } else if (response.status < 500) {
                    const respJson = JSON.parse(response.content);
                    respText = `Failure (${response.status}) ${JSON.stringify(respJson["detail"])}`
                } else {
                    respText = `Failure (${response.status}) ${response.content}`
                }
                document.getElementById("message").textContent = respText
            });
        });
    })
</script>
{% endblock %}
